#!/usr/bin/env python
import sys
import re
import glob
import os

_subject_re = re.compile('^subject= ' +
                         '(/C=(?P<C>[^/]+))?' +
                         '(/ST=(?P<ST>[^/]+))?' +
                         '(/L=(?P<L>[^/]+))?' +
                         '(/O=(?P<O>[^/]+))?' +
                         '(/CN=(?P<CN>[^/]+))?\s*$')
'subject= /C=US/ST=California/L=Mountain View/O=Google Inc/CN=*.google.com'

def display(expect, bld, tool):
    needle = re.compile("TLS-VALIDATION: %s" %
                        ("Failed" if expect == "Valid" else "Success"))
    prefix = "ok" if expect == "Valid" else "xf"
    subdir = tool.lower() if tool else '*'
    haystack = 'results/%s/%s/%s-*' % (subdir, bld, prefix)
    submsg = "%s " % tool if tool else ""
    fname_re = re.compile("results/(?P<subdir>\S+)/"
                          "(?P<bld>\S+)/(?P<prefix>..)-(?P<case>.*).out")
    subdirs = set()
    failures = {}  # casename => [subdir, subdir, ...]
    for filename in glob.glob(haystack):
        m = fname_re.match(filename)
        if not m:
            raise Exception("Unexpected filename structure %s" % filename)
        with open(filename, "r") as infile:
            contents = infile.read()
            if needle.search(contents):
                subdir = m.group('subdir')
                subdirs.add(subdir)
                assert bld == m.group('bld')
                assert prefix == m.group('prefix')
                case = m.group('case')
                if case not in failures:
                    failures[case] = []
                failures[case].append(subdir)
    if len(failures) == 0:
        return

    # Extract info about the test case from the subject/Organization
    case_text = {}
    for case in sorted(failures.keys()):
        certname = "certs/%s-%s.der" % (prefix, case)
        subject = os.popen('openssl x509 -in %s -inform der -subject -noout' % certname).read()
        m = _subject_re.match(subject)
        if m:
            case_text[case] = m.group('O')
        else:
            case_text[case] = subject

    if expect == "Valid":
        print "*** Valid certificates that failed %svalidation:" % submsg
    else:
        print "*** Invalid certificates that passed %svalidation:" % submsg
    subdirs = list(sorted(subdirs))
    for case in sorted(failures.keys()):
        flist = [" %-*s" % (len(s), s if s in failures[case] else '') for s in subdirs]
        print "  %-30s%s  '%s'" % ('%s:' % case, "".join(flist), case_text[case])


if __name__ == "__main__":
    display(sys.argv[1], sys.argv[2],
            sys.argv[3] if len(sys.argv) > 3 else None)
